Final: trigger_pipeline_calls.py
python
Copy
Edit
import requests
import os
from datetime import datetime

# ENV Vars
AIRTABLE_API_KEY = os.getenv("AIRTABLE_KEY")
BASE_ID = os.getenv("AIRTABLE_BASE_ID")
TABLE_NAME = os.getenv("TABLE_PIPELINE")  # ðŸ§  Scraped Leads (Universal)
SLACK_WEBHOOK_URL = os.getenv("SLACK_ALERT_URL")

# Airtable: Filter for leads in the pipeline
def get_pipeline_leads():
    url = f"https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}"
    params = {
        "filterByFormula": "AND({Status}='New', {Phone} != '')"
    }
    headers = {"Authorization": f"Bearer {AIRTABLE_API_KEY}"}
    res = requests.get(url, headers=headers, params=params)
    res.raise_for_status()
    return res.json().get("records", [])

# Initiate call
def call_lead(phone_number):
    requests.post("https://your-replit-url/initiate_call", json={"phone": phone_number})

# Optional: Slack alert if Hot Lead checkbox or Lead Score > 80
def send_slack_alert(lead):
    fields = lead["fields"]
    if fields.get("ðŸ”¥ Hot Lead") or fields.get("ðŸ“ˆ Lead Score", 0) >= 80:
        msg = f"""ðŸ”¥ *Hot Lead Alert*
ðŸ‘¤ {fields.get('Name', 'N/A')}
ðŸ“ž {fields.get('Phone')}
ðŸ“§ {fields.get('Email', 'N/A')}
"""
        requests.post(SLACK_WEBHOOK_URL, json={"text": msg})

# Optional: Log back to Airtable
def log_call_attempt(record_id):
    url = f"https://api.airtable.com/v0/{BASE_ID}/{TABLE_NAME}/{record_id}"
    headers = {
        "Authorization": f"Bearer {AIRTABLE_API_KEY}",
        "Content-Type": "application/json"
    }
    fields = {
        "ðŸ“… Last Called": datetime.utcnow().isoformat(),
        "ðŸ“ž Call Status": "Call Attempted"
    }
    requests.patch(url, json={"fields": fields}, headers=headers)

# Main handler
def handler(request):
    leads = get_pipeline_leads()
    for lead in leads:
        phone = lead["fields"].get("Phone")
        if not phone:
            continue

        call_lead(phone)
        send_slack_alert(lead)
        log_call_attempt(lead["id"])

    return {"calls_triggered": len(leads)}
ðŸ”§ What It Does:
âœ… Pulls all leads with Status = New and a phone number

âœ… Initiates calls using your existing /initiate_call module

âœ… Sends Slack alert only if:

ðŸ”¥ Hot Lead = true

OR ðŸ“ˆ Lead Score â‰¥ 80

âœ… Logs ðŸ“… Last Called and ðŸ“ž Call Status in Airtable

